name: Convert Markdown Resume with Pandoc (Eisvogel)

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Pull pandoc/extra (for warm cache)
        run: docker pull pandoc/extra:latest

      - name: Build PDFs (A4 & Letter) with Eisvogel
        shell: bash
        run: |
          set -euxo pipefail

          COMMON_OPTS=(
            --from=gfm+yaml_metadata_block+smart
            --template=eisvogel
            --pdf-engine=tectonic
            -V fontsize=10pt
            -V colorlinks=true
            -V linkcolor=MidnightBlue
            -V urlcolor=MidnightBlue
            -V maincolor=2B2D42
            -V accentcolor=EF476F
            -V listings=true
            -V disable-header-and-footer=true
          )

          # A4 version (nice for international printing)
          docker run --rm -v "$(pwd)":/repo --workdir /repo pandoc/extra:latest \
            README.md \
            "${COMMON_OPTS[@]}" \
            -V papersize=a4 \
            -V geometry:margin=0.5in \
            -o resume.pdf

          # US Letter version (common in the US)
          docker run --rm -v "$(pwd)":/repo --workdir /repo pandoc/extra:latest \
            README.md \
            "${COMMON_OPTS[@]}" \
            -V papersize=letter \
            -V geometry:margin=0.5in \
            -o resume-letter.pdf

      - name: Commit and Push Generated Files [skip ci]
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euxo pipefail
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          git add resume.pdf resume-letter.pdf || true
          if ! git diff --cached --quiet; then
            git commit -m "Update resume PDFs via GitHub Actions [skip ci]"
            git push "https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git" HEAD:main
          else
            echo "No changes to commit."
          fi
